services:
  postgres:
    image: postgres:16-alpine
    container_name: fendtastic-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-fendtastic}
      - POSTGRES_USER=${POSTGRES_USER:-fendtastic}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-fendtastic}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-fendtastic} -d ${POSTGRES_DB:-fendtastic}"]
      interval: 5s
      timeout: 3s
      retries: 20

  zenoh-router:
    image: eclipse/zenoh:latest
    container_name: fendtastic-zenoh-router
    ports:
      - "7447:7447"
      - "8000:8000"
    volumes:
      - ./config/zenoh-router.json5:/etc/zenoh/config.json5
    command: -c /etc/zenoh/config.json5

  eva-ics:
    image: altertech/eva-ics:latest
    container_name: fendtastic-eva-ics
    ports:
      - "7727:7727"
      - "4840:4840"
      - "8765:8765"   # MCP (Model Context Protocol) SSE server
    volumes:
      - eva-ics-data:/opt/eva4/runtime
      - ./config/eva-ics/svc-tpl-mcp.yml:/mcp-config/svc-tpl-mcp.yml:ro
      - ./config/eva-ics/entrypoint.sh:/mcp-config/entrypoint.sh:ro
    environment:
      - EVA_ICS_API_KEY=${EVA_ICS_API_KEY}
    entrypoint: ["/bin/bash", "/mcp-config/entrypoint.sh"]
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fendtastic-backend
    ports:
      - "8080:8080"
    environment:
      - ZENOH_ROUTER=tcp/zenoh-router:7447
      - EVA_ICS_URL=http://eva-ics:7727
      - EVA_ICS_API_KEY=${EVA_ICS_API_KEY}
      - PEA_CONFIG_DIR=/app/data/pea-configs
      - POL_DB_DIR=/app/data/pol
      - DATABASE_URL=postgres://${POSTGRES_USER:-fendtastic}:${POSTGRES_PASSWORD:-fendtastic}@postgres:5432/${POSTGRES_DB:-fendtastic}
    depends_on:
      postgres:
        condition: service_healthy
      zenoh-router:
        condition: service_started
      eva-ics:
        condition: service_started
    volumes:
      - ./config:/app/config
      - pea-configs:/app/data/pea-configs
      - pol-data:/app/data/pol

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: fendtastic-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend

volumes:
  postgres-data:
  eva-ics-data:
  pea-configs:
  pol-data:
